name: Deploy Application

on:
  push:
    branches:
      - ucasaappmain_testCICD_final_deploy
      - ucasaapp_testCICD_testSite_deploy
    paths:
      - "client/**"
      - "server/**"
      - ".github/workflows/deploy.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/ucasaappmain_testCICD_final_deploy' && 'production' || 'development' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: client/package-lock.json

      - name: Show Node/npm versions
        run: |
          node -v
          npm -v

      - name: Build Frontend
        working-directory: client
        env:
          CI: "false"
        run: |
          echo "üì¶ Installing frontend dependencies..."
          npm ci --legacy-peer-deps
          echo "üèóÔ∏è Building frontend..."
          npm run build
          echo "‚úÖ Frontend build completed"
          test -d build
          ls -la build | head -20

      - name: Prepare SSH and Deploy
        env:
          SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_APP_DIR: ${{ secrets.VPS_APP_DIR }}
          BRANCH_NAME: ${{ github.ref_name }}
          ENVIRONMENT: ${{ github.ref == 'refs/heads/ucasaappmain_testCICD_final_deploy' && 'production' || 'development' }}
          # App/runtime secrets (from GitHub Environment: development vs production)
          NODE_ENV: ${{ github.ref == 'refs/heads/ucasaappmain_testCICD_final_deploy' && 'production' || 'development' }}
          PORT: ${{ secrets.PORT }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          SMTP_EMAIL: ${{ secrets.SMTP_EMAIL }}
          SMTP_EMAIL_PASSWORD: ${{ secrets.SMTP_EMAIL_PASSWORD }}
          SMTP_NAME: ${{ secrets.SMTP_NAME }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_SECURE: ${{ secrets.SMTP_SECURE }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
          PM2_APP_NAME: ${{ github.ref == 'refs/heads/ucasaappmain_testCICD_final_deploy' && 'ucasaapp' || 'ucasaapp-test' }}
        run: |
          set -e

          echo "üöÄ Deploying from branch: $BRANCH_NAME to environment: $ENVIRONMENT"

          # Basic validation
          if [ -z "$SSH_KEY" ] || [ -z "$VPS_USER" ] || [ -z "$VPS_HOST" ] || [ -z "$VPS_APP_DIR" ]; then
            echo "ERROR: One or more required VPS_* secrets are missing or empty."
            echo "  VPS_SSH_KEY set?  -> $([ -n "$SSH_KEY" ] && echo yes || echo no)"
            echo "  VPS_USER set?     -> $([ -n "$VPS_USER" ] && echo yes || echo no)"
            echo "  VPS_HOST set?     -> $([ -n "$VPS_HOST" ] && echo yes || echo no)"
            echo "  VPS_APP_DIR set?  -> $([ -n "$VPS_APP_DIR" ] && echo yes || echo no)"
            exit 1
          fi

          PORT_OPT=""
          if [ -n "$VPS_PORT" ]; then
            PORT_OPT="-p $VPS_PORT"
          fi

          echo "üîê Preparing SSH for $VPS_USER@$VPS_HOST (port: ${VPS_PORT:-22})"

          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          
          SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts -o ConnectTimeout=30 -o ServerAliveInterval=60 -o ServerAliveCountMax=3"
          if [ -n "$VPS_PORT" ]; then
            SSH_OPTS="$SSH_OPTS -p $VPS_PORT"
          fi
          
          ssh-keyscan $([ -n "$VPS_PORT" ] && echo "-p $VPS_PORT") -H "$VPS_HOST" >> ~/.ssh/known_hosts 2>/dev/null || \
            echo "Warning: ssh-keyscan failed, continuing without pre-populated known_hosts"

          # Test SSH connection
          echo "üîç Testing SSH connection..."
          ssh $SSH_OPTS "$VPS_USER@$VPS_HOST" "echo 'SSH connection successful'" || {
            echo "ERROR: Failed to establish SSH connection to $VPS_HOST"
            exit 1
          }

          # Deploy Frontend Build
          echo "üì§ Deploying frontend build to VPS..."
          ssh $SSH_OPTS "$VPS_USER@$VPS_HOST" "mkdir -p $VPS_APP_DIR/build"
          rsync -az --delete -e "ssh $SSH_OPTS" client/build/ "$VPS_USER@$VPS_HOST:$VPS_APP_DIR/build/"
          echo "‚úÖ Frontend deployed successfully"

          # Deploy Backend Code
          echo "üì§ Deploying backend code to VPS..."
          rsync -az --delete -e "ssh $SSH_OPTS" \
            --exclude "node_modules" \
            server/ "$VPS_USER@$VPS_HOST:$VPS_APP_DIR/"
          echo "‚úÖ Backend code deployed successfully"

          
      - name: Install Dependencies and Restart Server
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_APP_DIR: ${{ secrets.VPS_APP_DIR }}
          NODE_ENV: ${{ github.ref == 'refs/heads/ucasaappmain_testCICD_final_deploy' && 'production' || 'development' }}
          PORT: ${{ secrets.PORT }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          SMTP_EMAIL: ${{ secrets.SMTP_EMAIL }}
          SMTP_EMAIL_PASSWORD: ${{ secrets.SMTP_EMAIL_PASSWORD }}
          SMTP_NAME: ${{ secrets.SMTP_NAME }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_SECURE: ${{ secrets.SMTP_SECURE }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
          PM2_APP_NAME: ${{ github.ref == 'refs/heads/ucasaappmain_testCICD_final_deploy' && 'ucasaapp' || 'ucasaapp-test' }}
        run: |
          SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts -o ConnectTimeout=30 -o ServerAliveInterval=60 -o ServerAliveCountMax=3"
          if [ -n "$VPS_PORT" ]; then
            SSH_OPTS="$SSH_OPTS -p $VPS_PORT"
          fi

          ssh $SSH_OPTS "$VPS_USER@$VPS_HOST" bash << EOF
          set -e
          echo "üìÇ Using VPS_APP_DIR: $VPS_APP_DIR"
          cd "$VPS_APP_DIR"

          # Validate required secrets
          if [ -z "$MONGODB_URI" ] || [ -z "$SMTP_EMAIL" ] || [ -z "$SMTP_EMAIL_PASSWORD" ] || [ -z "$SMTP_SERVER" ] || [ -z "$SMTP_PORT" ]; then
            echo "ERROR: Missing one or more required app secrets (MONGODB_URI / SMTP_*)."
            echo "Please add them under: Settings -> Environments -> (development/production) -> Secrets"
            exit 1
          fi

          # Write .env file from GitHub Environment secrets
          echo "üìù Creating .env file..."
          umask 077
          printf '%s\n' \
            "NODE_ENV=$NODE_ENV" \
            "PORT=$PORT" \
            "MONGODB_URI=$MONGODB_URI" \
            "SMTP_EMAIL=$SMTP_EMAIL" \
            "SMTP_EMAIL_PASSWORD=$SMTP_EMAIL_PASSWORD" \
            "SMTP_NAME=$SMTP_NAME" \
            "SMTP_SERVER=$SMTP_SERVER" \
            "SMTP_PORT=$SMTP_PORT" \
            "SMTP_SECURE=$SMTP_SECURE" \
            "SMTP_FROM=$SMTP_FROM" \
            > .env
          echo "‚úÖ .env file created"

          # Ensure Node.js/npm exist (auto-install on Debian/Ubuntu if possible)
          ensure_node() {
            if command -v node >/dev/null 2>&1 && command -v npm >/dev/null 2>&1; then
              return 0
            fi

            echo "üõ†Ô∏è Node.js/npm not found on VPS. Attempting to install..."

            if ! command -v apt-get >/dev/null 2>&1; then
              echo "‚ùå Cannot auto-install: apt-get not found on VPS."
              return 1
            fi

            if ! command -v sudo >/dev/null 2>&1; then
              echo "‚ùå Cannot auto-install: sudo not available on VPS."
              return 1
            fi

            # Non-interactive sudo required for CI
            sudo -n true 2>/dev/null || {
              echo "‚ùå Cannot auto-install: sudo requires a password (non-interactive sudo not enabled)."
              return 1
            }

            sudo -n apt-get update
            sudo -n env DEBIAN_FRONTEND=noninteractive apt-get install -y ca-certificates curl gnupg
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -n -E bash -
            sudo -n env DEBIAN_FRONTEND=noninteractive apt-get install -y nodejs
          }

          if ! ensure_node; then
            echo ""
            echo "‚ùå ERROR: npm is not installed on the VPS and auto-install failed."
            echo "Fix options:"
            echo "  - Enable passwordless sudo for this user (recommended for CI deploy user), or"
            echo "  - Pre-install Node.js on the VPS manually:"
            echo "      curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -"
            echo "      sudo apt-get install -y nodejs"
            exit 1
          fi

          # Install backend dependencies
          echo "üì¶ Installing backend dependencies..."
          echo "Node.js version: $(node --version)"
          echo "npm version: $(npm --version)"
          npm ci --omit=dev
          echo "‚úÖ Dependencies installed"

          # Restart server with PM2
          echo "üîÑ Restarting server..."
          if command -v pm2 >/dev/null 2>&1; then
            pm2 restart "$PM2_APP_NAME" || pm2 start index.js --name "$PM2_APP_NAME"
            pm2 save
            echo "‚úÖ Server restarted with PM2 (name: $PM2_APP_NAME)"
          else
            echo "‚ö†Ô∏è pm2 is not installed."
            if command -v sudo >/dev/null 2>&1 && sudo -n true 2>/dev/null; then
              echo "üõ†Ô∏è Installing pm2 globally..."
              sudo -n npm i -g pm2
              pm2 start index.js --name "$PM2_APP_NAME"
              pm2 save
              echo "‚úÖ Server started with PM2 (name: $PM2_APP_NAME)"
            else
              echo "‚û°Ô∏è Starting Node directly (no process manager)."
              nohup node index.js >/dev/null 2>&1 &
              echo "‚úÖ Server started (without PM2)"
            fi
          fi
          EOF

          echo ""
          echo "üéâ Deployment completed successfully!"
          echo "   Branch: ${{ github.ref_name }}"
          echo "   Environment: ${{ github.ref == 'refs/heads/ucasaappmain_testCICD_final_deploy' && 'production' || 'development' }}"
          echo "   PM2 App: ${{ github.ref == 'refs/heads/ucasaappmain_testCICD_final_deploy' && 'ucasaapp' || 'ucasaapp-test' }}"

