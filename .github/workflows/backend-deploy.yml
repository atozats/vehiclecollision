name: Deploy Backend

on:
  push:
    branches:
      - main
      - master
      - dev
    paths:
      - "server/**"
      - ".github/workflows/backend-deploy.yml"

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare SSH
        env:
          SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_APP_DIR: ${{ secrets.VPS_APP_DIR }}
          BRANCH_NAME: ${{ github.ref_name }}
          ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}
        run: |
          set -e

          echo "ðŸš€ Deploying from branch: $BRANCH_NAME to environment: $ENVIRONMENT"
          
          # Basic validation so failures clearly point to missing secrets
          if [ -z "$SSH_KEY" ] || [ -z "$VPS_USER" ] || [ -z "$VPS_HOST" ] || [ -z "$VPS_APP_DIR" ]; then
            echo "ERROR: One or more required VPS_* secrets are missing or empty."
            echo "  VPS_SSH_KEY set?  -> $([ -n "$SSH_KEY" ] && echo yes || echo no)"
            echo "  VPS_USER set?     -> $([ -n "$VPS_USER" ] && echo yes || echo no)"
            echo "  VPS_HOST set?     -> $([ -n "$VPS_HOST" ] && echo yes || echo no)"
            echo "  VPS_APP_DIR set?  -> $([ -n "$VPS_APP_DIR" ] && echo yes || echo no)"
            echo "  VPS_PORT (opt)?   -> $([ -n "$VPS_PORT" ] && echo yes || echo no)"
            exit 1
          fi

          
          PORT_OPT=""
          if [ -n "$VPS_PORT" ]; then
            PORT_OPT="-p $VPS_PORT"
          fi

          echo "Preparing SSH for $VPS_USER@$VPS_HOST (port: ${VPS_PORT:-22})"

          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          
          # Configure SSH options for better connection handling
          SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts -o ConnectTimeout=30 -o ServerAliveInterval=60 -o ServerAliveCountMax=3"
          if [ -n "$VPS_PORT" ]; then
            SSH_OPTS="$SSH_OPTS -p $VPS_PORT"
          fi
          
          # ssh-keyscan may fail if firewall blocks it; don't fail the whole job for that
          ssh-keyscan $([ -n "$VPS_PORT" ] && echo "-p $VPS_PORT") -H "$VPS_HOST" >> ~/.ssh/known_hosts 2>/dev/null || \
            echo "Warning: ssh-keyscan failed, continuing without pre-populated known_hosts"

          # Test SSH connection first
          echo "Testing SSH connection..."
          ssh $SSH_OPTS "$VPS_USER@$VPS_HOST" "echo 'SSH connection successful'" || {
            echo "ERROR: Failed to establish SSH connection to $VPS_HOST"
            echo "Please verify:"
            echo "  1. VPS_HOST is correct: $VPS_HOST"
            echo "  2. VPS_PORT is correct: ${VPS_PORT:-22}"
            echo "  3. VPS firewall allows connections from GitHub Actions IPs"
            echo "  4. SSH service is running on the VPS"
            exit 1
          }

          # Sync backend code to VPS (without node_modules)
          echo "Syncing backend files to VPS..."
          rsync -az --delete -e "ssh $SSH_OPTS" \
            --exclude "node_modules" \
            server/ "$VPS_USER@$VPS_HOST:$VPS_APP_DIR/"

      - name: Create .env file on server
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_APP_DIR: ${{ secrets.VPS_APP_DIR }}
          ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          APP_PORT: ${{ secrets.APP_PORT }}
          NODE_ENV: ${{ secrets.NODE_ENV }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_SECURE: ${{ secrets.SMTP_SECURE }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
          SMTP_NAME: ${{ secrets.SMTP_NAME }}
        run: |
          SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts -o ConnectTimeout=30 -o ServerAliveInterval=60 -o ServerAliveCountMax=3"
          if [ -n "$VPS_PORT" ]; then
            SSH_OPTS="$SSH_OPTS -p $VPS_PORT"
          fi

          echo "Creating .env file for environment..."
          ssh $SSH_OPTS "$VPS_USER@$VPS_HOST" bash << EOF
          set -e
          cd "$VPS_APP_DIR"
          
          # Create .env file with environment-specific variables
          cat > .env << ENVFILE
MONGODB_URI=${MONGODB_URI}
PORT=${APP_PORT}
NODE_ENV=${NODE_ENV}
SMTP_HOST=${SMTP_HOST}
SMTP_PORT=${SMTP_PORT}
SMTP_SECURE=${SMTP_SECURE}
SMTP_USER=${SMTP_USER}
SMTP_PASSWORD=${SMTP_PASSWORD}
SMTP_FROM=${SMTP_FROM}
SMTP_NAME=${SMTP_NAME}
ENVFILE

          echo "âœ… .env file created successfully"
          cat .env | head -3
          EOF

      - name: Install dependencies and restart Node server
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_APP_DIR: ${{ secrets.VPS_APP_DIR }}
          ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}
          PM2_APP_NAME: ${{ secrets.PM2_APP_NAME }}
        run: |
          SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts -o ConnectTimeout=30 -o ServerAliveInterval=60 -o ServerAliveCountMax=3"
          if [ -n "$VPS_PORT" ]; then
            SSH_OPTS="$SSH_OPTS -p $VPS_PORT"
          fi

          ssh $SSH_OPTS "$VPS_USER@$VPS_HOST" bash << EOF
          set -e
          echo "Deploying to $ENVIRONMENT environment"
          echo "Using VPS_APP_DIR: $VPS_APP_DIR"
          cd "$VPS_APP_DIR"

          # Install/refresh production dependencies
          if command -v npm >/dev/null 2>&1; then
            npm ci --omit=dev
          else
            echo "npm is not installed on the VPS. Please install Node.js and npm."
            exit 1
          fi

          # Set PM2 app name (use from secret or default)
          PM2_NAME=\${PM2_APP_NAME:-ucasaapp}
          
          # Restart the Node process with pm2 (recommended)
          if command -v pm2 >/dev/null 2>&1; then
            echo "Restarting PM2 app: \$PM2_NAME"
            pm2 restart \$PM2_NAME || pm2 start index.js --name \$PM2_NAME
            pm2 save
            echo "âœ… Deployment completed successfully"
            pm2 list
          else
            echo "pm2 is not installed. Starting Node directly (no process manager)."
            # WARNING: this will die if the VPS reboots; install pm2 for production
            # You can replace this with a systemd service if you prefer.
            nohup node index.js >/dev/null 2>&1 &
          fi
          EOF

